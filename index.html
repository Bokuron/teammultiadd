<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Team Formation Builder</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{background:linear-gradient(180deg,#071029 0%,#071428 100%);color:#e6eef6;margin:0;padding:24px}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:20px}
    .card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:12px;margin-top:16px}
    textarea{width:100%;height:160px;padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,0.04);background:transparent;color:inherit}
    label{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:8px;margin-top:12px}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#022;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    pre{background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;overflow:auto}
    .flex{display:flex;gap:8px;align-items:center}
    .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:13px}
    .out{margin-top:12px}
    .success{color:#b7f5d6}
    .error{color:#ffb4b4}
    .copy{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Team Formation Builder</h1>
      <div class="pill"></div>
    </header>

    <div class="card">
      <label>Paste your team here (one line per hero). Supported formats (tabs, commas or pipes):</label>
      <textarea id="input"></textarea>
      <div class="row">
        <button id="run">Calculate</button>
        <div class="small">Exactly 6 heroes are expected. Role detection: off / def / sup</div>
      </div>

      <div class="out">
        <div id="formation" class="small"></div>
        <pre id="ids" style="display:none"></pre>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <input id="cmd" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" readonly />
          <button id="copy" class="copy">Copy</button>
        </div>
        <div id="msg" class="small"></div>
      </div>

      <footer>
        Algorithm: Finds the formation with an exact match of role counts (e.g. Off ×4, Sup ×2) and arranges IDs in the formation order. Heroes with the same role keep their input order.
      </footer>
    </div>
  </div>

<script>
const formations = {
  "Offense 1": ["Off","Off","Off","Off","Off","Sup"],
  "Offense 2": ["Off","Off","Off","Off","Off","Def"],
  "Offense 3": ["Off","Off","Off","Off","Sup","Sup"],
  "Offense 4": ["Off","Off","Off","Off","Def","Def"],
  "Offense 5": ["Off","Off","Off","Def","Def","Sup"],
  "Offense 6": ["Off","Off","Off","Def","Sup","Sup"],
  "Offense 7": ["Off","Off","Off","Off","Sup","Def"],
  "Neutral 1": ["Sup","Sup","Sup","Sup","Sup","Sup"],
  "Neutral 2": ["Sup","Sup","Sup","Sup","Def","Off"],
  "Neutral 3": ["Sup","Sup","Sup","Def","Def","Off"],
  "Neutral 4": ["Sup","Sup","Sup","Off","Off","Def"],
  "Neutral 5": ["Sup","Sup","Off","Off","Def","Def"],
  "Neutral 6": ["Sup","Sup","Sup","Sup","Sup","Def"],
  "Neutral 7": ["Sup","Sup","Sup","Sup","Sup","Off"],
  "Defense 1": ["Def","Def","Def","Def","Sup","Sup"],
  "Defense 2": ["Def","Def","Def","Def","Off","Off"],
  "Defense 3": ["Def","Def","Def","Def","Def","Off"],
  "Defense 4": ["Def","Def","Def","Def","Sup","Sup"],
  "Defense 5": ["Off","Off","Def","Def","Def","Sup"],
  "Defense 6": ["Off","Sup","Def","Def","Def","Def"],
  "Defense 7": ["Off","Sup","Sup","Def","Def","Def"],
};

function parseLine(line){
  const parts = line.trim().split(/\t|\||,/).map(p=>p.trim()).filter(p=>p.length);
  if(parts.length < 3) return null;
  let id = '';
  if(parts.length >= 4) id = parts[3];
  else id = parts[ parts.length-1 ];
  const role = parts.find(p=>/off|def|sup/i.test(p)) || parts[2] || '';
  const name = parts[0];
  return {name, role, id};
}

function normalizeRole(r){
  if(!r) return '';
  r = r.toLowerCase();
  if(r.includes('off')) return 'Off';
  if(r.includes('def')) return 'Def';
  if(r.includes('sup')) return 'Sup';
  return '';
}

function findFormation(counts){
  for(const [name,pattern] of Object.entries(formations)){
    const cOff = pattern.filter(x=>x==='Off').length;
    const cDef = pattern.filter(x=>x==='Def').length;
    const cSup = pattern.filter(x=>x==='Sup').length;
    if(cOff===counts.Off && cDef===counts.Def && cSup===counts.Sup) return {name,pattern};
  }
  return null;
}

function buildCommand(order, pattern){
  const ids = [];
  const pools = {Off:[],Def:[],Sup:[]};
  for(const h of order){
    const nr = normalizeRole(h.role);
    if(nr && h.id) pools[nr].push(h);
  }
  for(const role of pattern){
    const pool = pools[role];
    if(!pool || pool.length===0) return {error:`No heroes left for role ${role}`};
    const hero = pool.shift();
    ids.push(hero.id);
  }
  return {ids};
}



document.getElementById('run').addEventListener('click', ()=>{
  const raw = document.getElementById('input').value.trim();
  const msg = document.getElementById('msg');
  const formationEl = document.getElementById('formation');
  const idsEl = document.getElementById('ids');
  const cmd = document.getElementById('cmd');
  msg.textContent=''; formationEl.textContent=''; idsEl.style.display='none'; idsEl.textContent=''; cmd.value='';

  if(!raw){ msg.textContent='Please enter your team.'; msg.className='error'; return; }

  // 1. Split into blocks: multi-line heroes start with "Name | ID:" or single-line tab/comma/pipe
  let blocks;
  if(raw.match(/^\s*.+\| ID:/m)){
    blocks = raw.split(/(?=^.+\| ID:)/m).map(b=>b.trim()).filter(b=>b.length);
  } else {
    // fallback: every non-empty line is a hero
    blocks = raw.split('\n').map(l=>l.trim()).filter(l=>l.length);
  }

  if(blocks.length!==6){ msg.textContent='You must enter exactly 6 heroes.'; msg.className='error'; return; }

  // 2. Parse each block
  const heroes = blocks.map(block=>{
    if(block.includes('ID:')){
      // multi-line block
      const idMatch = block.match(/ID:\s*(s\d+)/i);
      const powerMatch = block.match(/PWR:\s*(\d+)(?:\s*\(\+(\d+)\))?/i);
      const typeMatch = block.match(/Type:\s*(Offense|Defense|Support)/i);
      const nameMatch = block.match(/^([^|\n]+)/);
      const name = nameMatch ? nameMatch[1].trim() : 'Unknown';
      const id = idMatch ? idMatch[1] : '';
      const basePwr = powerMatch ? parseInt(powerMatch[1]) : 0;
      const bonusPwr = powerMatch && powerMatch[2] ? parseInt(powerMatch[2]) : 0;
      const totalPwr = basePwr + bonusPwr;
      const roleRaw = typeMatch ? typeMatch[1] : '';
      return {name, id, role: normalizeRole(roleRaw), power: totalPwr};
    } else {
      // single-line tab/comma/pipe
      const parts = block.split(/\t|,|\|/).map(p=>p.trim()).filter(p=>p.length);
      if(parts.length < 3) return null;
      const name = parts[0];
      const id = parts.find(p=>/^s\d+$/i.test(p)) || parts[parts.length-1];
      const role = parts.find(p=>/off|def|sup/i.test(p)) || parts[2] || '';
      return {name, role: normalizeRole(role), id};
    }
  });

  if(heroes.some(h=>!h.id || !h.role)){ 
    msg.textContent='Parsing error. Ensure each hero has an ID and a role (Off/Def/Sup).'; 
    msg.className='error'; 
    return; 
  }

  // 3. Count roles
  const counts = {Off:0,Def:0,Sup:0}; 
  heroes.forEach(h=>{if(h.role) counts[h.role]++;});

  // 4. Find formation
  const found = findFormation(counts);
  if(!found){ 
    msg.textContent='No matching formation found for this role distribution.'; 
    msg.className='error'; 
    return; 
  }

  formationEl.textContent = `Formation: ${found.name} — ${found.pattern.join(', ')}`;

  // 5. Build /multi command
  const built = buildCommand(heroes, found.pattern);
  if(built.error){ msg.textContent=built.error; msg.className='error'; return; }

  const ids = built.ids.join(',');
  idsEl.style.display='block'; idsEl.textContent = ids;
  cmd.value = `/multi teamadd preset:PVP query:${ids}`;
  msg.textContent='Success!'; msg.className='success';
});

document.getElementById('copy').addEventListener('click', ()=>{
  const cmd = document.getElementById('cmd');
  if(!cmd.value) return;
  navigator.clipboard.writeText(cmd.value).then(()=>{
    const m = document.getElementById('msg'); m.textContent='Copied!'; m.className='success';
  });
});
</script>
</body>
</html>
